<template>
  <div
    id="wg-api-football-games"
    data-host="v3.football.api-sports.io"
    :data-key="key"
    data-date=""
    data-league=""
    data-season=""
    data-theme="grey"
    data-refresh="600"
    data-show-toolbar="false"
    data-show-errors="false"
    data-show-logos="true"
    data-modal-game="true"
    data-modal-standings="true"
    data-modal-show-logos="true"
  ></div>
  <!-- <div
    id="wg-api-football-games"
    data-host="v3.football.api-sports.io"
    data-key="ecc8e0a784e36be844e86fa2e67b8f01"
    data-date="2022-12-14"
    data-league=""
    data-season=""
    data-theme="grey"
    data-refresh="600"
    data-show-toolbar="false"
    data-show-errors="false"
    data-show-logos="true"
    data-modal-game="true"
    data-modal-standings="true"
    data-modal-show-logos="true"
    class="center widget-80"
    data-v-7ab20b76=""
  >
    <div id="wg-football-data" class="">
      <table class="wg-table" id="wg-football-games">
        <thead></thead>

        <tbody>
          <tr id="football-league-1">
            <td width="24px">
              <img src="/img/star_fill.f40678a6.png" style="width: 2rem" />
            </td>
            <td class="wg_header" colspan="8">
              <img
                class="wg_flag"
                src="null"
                loading="lazy"
                onerror='this.style.display="none"'
                style="display: none"
              />
              World: World Cup
              <span data-id="football-league-1" class="wg_arrow wg_arrow_up"
                >❯</span
              >
              <span
                data-sport="football"
                data-league="1"
                data-season="2022"
                class="wb_header_link wg_load_standings"
                >Standings</span
              >
            </td>
          </tr>
          <tr
            id="football-game-978488"
            class="football-league-1 date-semi-finals football-games-select"
            data-status="FT"
            data-league="1"
            data-date="semi-finals"
          >
            <td width="24px">
              <img src="/img/star.801fa52b.png" style="width: 2rem" />
            </td>
            <td
              id="football-game-status-978488"
              class="wg_tooltip wg_width_30 wg_text_center wg_finished"
              data-text="Match Finished"
              style="cursor: pointer"
            >
              FT
            </td>
            <td style="cursor: pointer">
              <span id="football-home-978488" class="wg_nowrap wg_bolder"
                ><img
                  class="wg_logo"
                  src="https://media-2.api-sports.io/football/teams/2.png"
                  loading="lazy"
                  onerror='this.style.display="none"'
                />
                France</span
              >
              <br />
              <span id="football-away-978488" class="undefined wg_nowrap"
                ><img
                  class="wg_logo"
                  src="https://media-2.api-sports.io/football/teams/31.png"
                  loading="lazy"
                  onerror='this.style.display="none"'
                />
                Morocco</span
              >
            </td>
            <td
              id="football-game-score-978488"
              class="wg_width_20 wg_text_center wg_bolder undefined"
              style="cursor: pointer"
            >
              2<br />0
            </td>
            <td
              id="football-game-ht-978488"
              class="wg_width_20 wg_bolder_300 wg_text_center wg_tooltip wg_tooltip_left undefined"
              data-text="Halftime score"
              style="cursor: pointer"
            >
              (1)<br />(0)
            </td>
            <td class="wg_width_20 wg_text_center">
              <span
                class="wg_info wg_tooltip wg_tooltip_left wg_load_game"
                data-sport="football"
                data-id="978488"
                data-text="Show Fixture"
                style="width: 50px"
                >Modal</span
              >
            </td>
          </tr>
          <tr id="football-league-277">
            <td width="24px">
              <img src="/img/star.801fa52b.png" style="width: 2rem" />
            </td>
            <td class="wg_header" colspan="8">
              <img
                class="wg_flag"
                src="https://media-2.api-sports.io/flags/ke.svg"
                loading="lazy"
                onerror='this.style.display="none"'
              />
              Kenya: Super League
              <span data-id="football-league-277" class="wg_arrow wg_arrow_up"
                >❯</span
              >
              <span
                data-sport="football"
                data-league="277"
                data-season="2022"
                class="wb_header_link wg_load_standings"
                >Standings</span
              >
            </td>
          </tr>

          <tr
            id="football-game-973323"
            class="football-league-277 date-regular-season---4 football-games-select"
            data-status="PST"
            data-league="277"
            data-date="regular-season---4"
          >
            <td width="24px">
              <img src="/img/star.801fa52b.png" style="width: 2rem" />
            </td>
            <td
              id="football-game-status-973323"
              class="wg_tooltip wg_width_30 wg_text_center wg_canceled"
              data-text="Match Postponed"
              style="cursor: pointer"
            >
              PST
            </td>
            <td style="cursor: pointer">
              <span id="football-home-973323" class="undefined wg_nowrap"
                ><img
                  class="wg_logo"
                  src="https://media-5.api-sports.io/football/teams/19488.png"
                  loading="lazy"
                  onerror='this.style.display="none"'
                />
                Naivas</span
              >
              <br />
              <span id="football-away-973323" class="undefined wg_nowrap"
                ><img
                  class="wg_logo"
                  src="https://media-2.api-sports.io/football/teams/19480.png"
                  loading="lazy"
                  onerror='this.style.display="none"'
                />
                Fortune Sacco</span
              >
            </td>
            <td
              id="football-game-score-973323"
              class="wg_width_20 wg_text_center wg_bolder undefined"
              style="cursor: pointer"
            >
              -<br />-
            </td>
            <td
              id="football-game-ht-973323"
              class="wg_width_20 wg_bolder_300 wg_text_center wg_tooltip wg_tooltip_left undefined"
              data-text="Halftime score"
              style="cursor: pointer"
            >
              <br />
            </td>
            <td class="wg_width_20 wg_text_center">
              <span
                class="wg_info wg_tooltip wg_tooltip_left wg_load_game"
                data-sport="football"
                data-id="973323"
                data-text="Show Fixture"
                style="width: 50px"
                >Modal</span
              >
            </td>
          </tr>

          <tr
            id="football-game-973326"
            class="football-league-277 date-regular-season---4 football-games-select"
            data-status="PST"
            data-league="277"
            data-date="regular-season---4"
          >
            <td width="24px">
              <img src="/img/star.801fa52b.png" style="width: 2rem" />
            </td>
            <td
              id="football-game-status-973326"
              class="wg_tooltip wg_width_30 wg_text_center wg_canceled"
              data-text="Match Postponed"
              style="cursor: pointer"
            >
              PST
            </td>
            <td style="cursor: pointer">
              <span id="football-home-973326" class="undefined wg_nowrap"
                ><img
                  class="wg_logo"
                  src="https://media-4.api-sports.io/football/teams/19483.png"
                  loading="lazy"
                  onerror='this.style.display="none"'
                />
                Mara Sugar</span
              >
              <br />
              <span id="football-away-973326" class="undefined wg_nowrap"
                ><img
                  class="wg_logo"
                  src="https://media-4.api-sports.io/football/teams/19476.png"
                  loading="lazy"
                  onerror='this.style.display="none"'
                />
                APS Bomet</span
              >
            </td>
            <td
              id="football-game-score-973326"
              class="wg_width_20 wg_text_center wg_bolder undefined"
              style="cursor: pointer"
            >
              -<br />-
            </td>
            <td
              id="football-game-ht-973326"
              class="wg_width_20 wg_bolder_300 wg_text_center wg_tooltip wg_tooltip_left undefined"
              data-text="Halftime score"
              style="cursor: pointer"
            >
              <br />
            </td>
            <td class="wg_width_20 wg_text_center">
              <span
                class="wg_info wg_tooltip wg_tooltip_left wg_load_game"
                data-sport="football"
                data-id="973326"
                data-text="Show Fixture"
                style="width: 50px"
                >Modal</span
              >
            </td>
          </tr>

          
        </tbody>
      </table>
    </div>
  </div> -->
</template>

<script>
import { ref, onMounted, onBeforeMount, getCurrentInstance } from 'vue';
import Store from '@/store/Store';
import { useStore } from 'vuex';
import axios from 'axios';
import router from '@/router';
export default {
  setup() {
    const key = ref(process.env.VUE_APP_API_KEY);
    const store = useStore();

    function moveRows(leagueId) {
      const rows = document.querySelector('table').rows,
        parent = rows[0].parentNode;

      const leagueToMove = document.querySelector(`#${leagueId}`);
      const gamesToMove = document.querySelectorAll(`.${leagueId}`);

      // League to first row
      parent.insertBefore(leagueToMove, rows[0]);

      // Games to go under favourite league
      for (let i = 0; i < gamesToMove.length; i++) {
        parent.insertBefore(gamesToMove[i], rows[i + 1]);
      }
    }

    function goToMatchPage(row) {
      if (row.id.startsWith('football-game')) {
        const cells = row.querySelectorAll('td:not(:last-child)');
        cells.forEach(function (el) {
          el.style.cursor = 'pointer';
          el.addEventListener('click', () => {
            console.log(row.id);
            router.push({
              name: 'Match details',
              params: { id: `${row.id.slice(14)}` },
            });
            setTimeout(() => {
              location.reload();
            }, 500);
          });
        });
      } else {
        console.log('League!!!');
      }
    }

    onBeforeMount(() => {
      console.log('log');
      const current = getCurrentInstance();
      current.proxy.$forceUpdate();
    });

    setTimeout(
      onMounted(async () => {
        const rows = document.querySelectorAll('tr');

        // Details button change
        const details = document.querySelectorAll('span[class*="wg_info"]');

        details.forEach(function (el) {
          el.innerHTML = 'Modal';
          el.style.width = '50px';
        });

        rows.forEach(function (el) {
          if (el.id.startsWith('football-game')) {
            goToMatchPage(el);
          }
        });

        if (Store.state.userIsAuthorized) {
          store.dispatch('getFavourites');
          // console.log(store.getters.favourites);

          // MOVE FAVOURITES ON TOP
          // Get favourites from database

          rows.forEach(function (el) {
            // Add button to every table row
            const btn = document.createElement('td');
            btn.setAttribute('width', '24px');
            const star = document.createElement('img');
            btn.appendChild(star);
            let favourites = store.getters.favourites;
            const { games, leagues } = favourites;

            let isFav;

            if (leagues.includes(el.id)) {
              moveRows(el.id);
            }

            if (leagues.includes(el.id) || games.includes(el.id)) {
              star.setAttribute('src', require('@/assets/icons/star_fill.png'));
              star.style = 'width: 2rem';
              isFav = true;
            } else {
              star.setAttribute('src', require('@/assets/icons/star.png'));
              star.style = 'width: 2rem';
              isFav = false;
            }

            btn.onclick = function () {
              if (el.id.startsWith('football-league')) {
                const params = {
                  username: localStorage.getItem('username'),
                  leagueId: el.id,
                };
                console.log(params);
                // Add league ID to database
                if (isFav) {
                  axios
                    .delete('http://localhost:5000/users/favourite-leagues', {
                      params,
                    })
                    .then(
                      (res) => {
                        if (res.status == '200') {
                          console.log(`Removed league ID ${params.leagueId}`);
                        }
                      },
                      (err) => {
                        console.log(err.response);
                      }
                    );
                  star.setAttribute('src', require('@/assets/icons/star.png'));
                  star.style = 'width: 2rem';
                  isFav = false;
                  // Move league to the top
                } else {
                  axios
                    .post(
                      'http://localhost:5000/users/favourite-leagues',
                      params
                    )
                    .then(
                      (res) => {
                        if (res.status == '200') {
                          console.log(`Added league ID ${params.leagueId}`);
                        }
                      },
                      (err) => {
                        console.log(err.response);
                      }
                    );
                  star.setAttribute(
                    'src',
                    require('@/assets/icons/star_fill.png')
                  );
                  star.style = 'width: 2rem';
                  isFav = true;
                  // Move league to the top
                  moveRows(el.id);
                }
              } else if (el.id.startsWith('football-game')) {
                const params = {
                  username: localStorage.getItem('username'),
                  gameId: el.id,
                };
                // Add game ID to database
                if (isFav) {
                  axios
                    .delete('http://localhost:5000/users/favourite-games', {
                      params,
                    })
                    .then(
                      (res) => {
                        if (res.status == '200') {
                          console.log(`Removed game ID ${params.gameId}`);
                        }
                      },
                      (err) => {
                        console.log(err.response);
                      }
                    );
                  star.setAttribute('src', require('@/assets/icons/star.png'));
                  star.style = 'width: 2rem';
                  isFav = false;
                } else {
                  axios
                    .post('http://localhost:5000/users/favourite-games', params)
                    .then(
                      (res) => {
                        if (res.status == '200') {
                          console.log(`Added game ID ${params.gameId}`);
                        }
                      },
                      (err) => {
                        console.log(err.response);
                      }
                    );
                  star.setAttribute(
                    'src',
                    require('@/assets/icons/star_fill.png')
                  );
                  star.style = 'width: 2rem';
                  isFav = true;
                }
                console.log(isFav);
              }
            };
            el.insertBefore(btn, el.firstChild);
          });
        }
      }),
      1000
    );

    return {
      key,
    };
  },
};
</script>

<style lang="scss" src="./GamesWidgetComponent.scss" scoped />
